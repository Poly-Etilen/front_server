name: Backend CI/CD (Java/Thymeleaf)

on:
  push:
    branches: [ "main", "dev", "feature/**" ]
  pull_request:
    branches: [ "main", "dev", "feature/**" ]

jobs:
  build-and-deploy-java:



    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven' # Gradle을 쓴다면 'gradle'로 변경

      - name: Build with Maven
        run: mvn clean package


      # 4. 빌드된 .jar 파일을 SCP를 이용해 서버로 전송
      - name: Upload JAR file via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}

          # 'target/' 디렉토리 아래에 생성된 .jar 파일을 전송합니다.
          source: "target/*.jar"

          # 'source'에서 지정한 파일을 이 'target' 디렉토리로 전송합니다.
          target: "~/www/nhnbook"

          # 'target/' 디렉토리 구조를 제거하고 파일(.jar)만 전송합니다.
          strip_components: 1

      # 5. [추가] SSH를 이용해 서버에서 .jar 파일 실행
      - name: Run JAR file on server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # 1. .jar 파일이 업로드된 디렉토리로 이동
            cd ~/www/nhnbook
            
            # 2. 방금 업로드한 .jar 파일의 이름을 찾습니다 (가장 최신 파일)
            JAR_NAME=$(ls -t *.jar | head -n 1)
            
            # 3. 기존에 실행 중이던 Java 프로세스(이전 버전)를 찾아서 종료
            # 'pgrep -f $JAR_NAME' 는 $JAR_NAME 변수를 포함하는 모든 프로세스 ID(PID)를 찾습니다.
            PID=$(pgrep -f $JAR_NAME)
            if [ -n "$PID" ]; then
              echo "Stopping existing process (PID: $PID)..."
              kill -15 $PID
              sleep 5 # 종료 대기
            fi
            
            # 4. 새로운 .jar 파일 실행 (포트 지정 옵션 제거됨)
            # [수정됨] .jar 파일 내의 application.yml에 설정된 포트로 실행됩니다.
            echo "Starting new process: $JAR_NAME (using embedded port)"
            nohup java -jar $JAR_NAME > app.log 2>&1 &