name: Front CI/CD (Blue/Green Docker)

on:
  push:
    branches: [ "main", "dev", "feature/**" ]
  pull_request:
    branches: [ "main", "dev", "feature/**" ]

jobs:
  build-push-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # ... (ë¹Œë“œ, í‘¸ì‹œ ë‹¨ê³„ëŠ” ë™ì¼) ...

      # 4. SSHë¡œ B/G ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run Blue/Green Deploy Script on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            DEPLOY_PATH="~/www/nhnbook"
            SERVICE_NAME="front_server"
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
            
            # --- ğŸ”µ í”„ë¡ íŠ¸ í¬íŠ¸ ì •ì˜ (ìš”ì²­ëŒ€ë¡œ ìˆ˜ì •) ---
            BLUE_PORT="10483"
            GREEN_PORT="10484"
            
            cd $DEPLOY_PATH

            # --- 1. í˜„ì¬ í™œì„± 'Front' í¬íŠ¸ í™•ì¸ ---
            CURRENT_FRONT_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/front_upstream.conf)

            # --- 2. ë°°í¬í•  ëŒ€ìƒ(Idle) í™˜ê²½ ê²°ì • ---
            if [ "$CURRENT_FRONT_PORT" == "$BLUE_PORT" ]; then
              echo "Current Front is BLUE ($BLUE_PORT). Deploying to GREEN ($GREEN_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_FRONT_PORT=$GREEN_PORT
            else
              echo "Current Front is GREEN ($GREEN_PORT). Deploying to BLUE ($BLUE_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              TARGET_FRONT_PORT=$BLUE_PORT
            fi

            # --- 3. ë¹„í™œì„±(Idle) í™˜ê²½ì— ìƒˆ 'front_server' ë°°í¬ ---
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull $SERVICE_NAME
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps $SERVICE_NAME

            # --- 4. í—¬ìŠ¤ì²´í¬ (ê°„ë‹¨íˆ sleep) ---
            echo "Waiting for 30 seconds for service to start..."
            sleep 30 
            
            # --- 5. Nginx 'Front' íŠ¸ë˜í”½ ì „í™˜ ---
            echo "Switching Nginx traffic to $TARGET_FRONT_PORT..."
            echo "server 127.0.0.1:$TARGET_FRONT_PORT;" > $NGINX_CONF_PATH/conf.d/front_upstream.conf

            # --- 6. Nginx ì„¤ì • ë¦¬ë¡œë“œ (ì¤‘ë‹¨ ì—†ìŒ) ---
            sudo nginx -s reload
            
            echo "Deployment successful! Front traffic now routed to $TARGET_FRONT_PORT."
            docker image prune -f