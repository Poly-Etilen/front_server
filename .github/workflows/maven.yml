# This workflow will build a Java project (like Spring Boot with Thymeleaf)
# using Maven, and deploy the executable JAR file to a server.

name: Front CI/CD (Java/Thymeleaf)

on:
  push:
    branches: [ "main", "dev", "feature/**" ]
  pull_request:
    branches: [ "main", "dev", "feature/**" ]

jobs:
  build-and-deploy-java: # Job 이름을 Java 배포용으로 변경



    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven' # Gradle을 쓴다면 'gradle'로 변경

      # 3. [추가] Maven으로 프로젝트 빌드 (JAR 파일 생성)
      # 이 스텝이 성공하면 'target/' 디렉토리에 .jar 파일이 생성됩니다.
      - name: Build with Maven
        run: mvn clean package

          # 2. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # (시크릿 이름 확인)
          password: ${{ secrets.DOCKER_PASSWORD }}


      # 3. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 2번에서 정의한 'front_server' 이미지 이름
          tags: fbxogns123/front-server:latest

      # 4. SSH로 B/G 배포 스크립트 실행
      - name: Run Blue/Green Deploy Script on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # 이 스크립트는 'front_server'만 재시작하고 Nginx 트래픽을 전환합니다.
            
            DEPLOY_PATH="~/www/nhnbook"
            SERVICE_NAME="front_server" # ⬅️ 이 서비스만 배포
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx" # ⬅️ Nginx 경로 (권한 문제 확인 필요)
            
            cd $DEPLOY_PATH

            # --- 1. 현재 활성 'Front' 포트 확인 ---
            # (Nginx 권한 문제 해결 후 이 경로 사용)
            CURRENT_FRONT_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/front_upstream.conf)

            # --- 2. 배포할 대상(Idle) 환경 결정 ---
            if [ "$CURRENT_FRONT_PORT" == "10481" ]; then
              echo "Current Front is BLUE (10481). Deploying to GREEN (10482)..."
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_FRONT_PORT="10482"
            else
              echo "Current Front is GREEN (10482). Deploying to BLUE (10481)..."
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              TARGET_FRONT_PORT="10481"
            fi

            # --- 3. 비활성(Idle) 환경에 새 'front_server' 배포 ---
            docker-compose -f $TARGET_COMPOSE_FILE pull $SERVICE_NAME
            docker-compose -f $TARGET_COMPOSE_FILE up -d --no-deps $SERVICE_NAME

            # --- 4. (중요) 헬스체크 (간단히 sleep) ---
            echo "Waiting for 30 seconds for service to start..."
            sleep 30 
            
            # --- 5. Nginx 'Front' 트래픽 전환 ---
            echo "Switching Nginx traffic to $TARGET_FRONT_PORT..."
            echo "server 127.0.0.1:$TARGET_FRONT_PORT;" > $NGINX_CONF_PATH/conf.d/front_upstream.conf

            # --- 6. Nginx 설정 리로드 (중단 없음) ---
            sudo nginx -s reload
            
            echo "Deployment successful! Front traffic now routed to $TARGET_FRONT_PORT."
            docker image prune -f