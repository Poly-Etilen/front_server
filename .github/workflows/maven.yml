# This workflow will build a Java project (like Spring Boot with Thymeleaf)
# using Maven, and deploy the executable JAR file to a server.

name: Front CI/CD (Java/Thymeleaf)

on:
  push:
    branches: [ "main", "dev", "feature/**" ]
  pull_request:
    branches: [ "main", "dev", "feature/**" ]

jobs:
  build-and-deploy-java: # Job ì´ë¦„ì„ Java ë°°í¬ìš©ìœ¼ë¡œ ë³€ê²½



    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven' # Gradleì„ ì“´ë‹¤ë©´ 'gradle'ë¡œ ë³€ê²½

      # 3. [ì¶”ê°€] Mavenìœ¼ë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ (JAR íŒŒì¼ ìƒì„±)
      # ì´ ìŠ¤í…ì´ ì„±ê³µí•˜ë©´ 'target/' ë””ë ‰í† ë¦¬ì— .jar íŒŒì¼ì´ ìƒì„±ë©ë‹ˆë‹¤.
      - name: Build with Maven
        run: mvn clean package

          # 2. Docker Hub ë¡œê·¸ì¸
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }} # (ì‹œí¬ë¦¿ ì´ë¦„ í™•ì¸)
          password: ${{ secrets.DOCKER_PASSWORD }}


      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # 2ë²ˆì—ì„œ ì •ì˜í•œ 'front_server' ì´ë¯¸ì§€ ì´ë¦„
          tags: fbxogns123/front-server:latest

      # 4. SSHë¡œ B/G ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Run Blue/Green Deploy Script on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_IP }}
          username: ${{ secrets.SSH_ID }}
          password: ${{ secrets.SSH_PW }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” 'front_server'ë§Œ ì¬ì‹œì‘í•˜ê³  Nginx íŠ¸ë˜í”½ì„ ì „í™˜í•©ë‹ˆë‹¤.
            
            DEPLOY_PATH="~/www/nhnbook"
            SERVICE_NAME="front_server"
            NGINX_CONF_PATH="/home/backend/be12-team5/nginx"
            
            # --- ğŸ”µ ë¸”ë£¨/ê·¸ë¦° í¬íŠ¸ ì •ì˜ ---
            BLUE_PORT="10481"
            GREEN_PORT="10491" # â¬…ï¸ '10482'ê°€ ì•„ë‹Œ '10491'ë¡œ ìˆ˜ì •
            
            cd $DEPLOY_PATH

            # --- 1. í˜„ì¬ í™œì„± 'Front' í¬íŠ¸ í™•ì¸ ---
            CURRENT_FRONT_PORT=$(grep -o '[0-9]\{5\}' $NGINX_CONF_PATH/conf.d/front_upstream.conf)

            # --- 2. ë°°í¬í•  ëŒ€ìƒ(Idle) í™˜ê²½ ê²°ì • ---
            if [ "$CURRENT_FRONT_PORT" == "$BLUE_PORT" ]; then
              echo "Current Front is BLUE ($BLUE_PORT). Deploying to GREEN ($GREEN_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-green.yml"
              TARGET_FRONT_PORT=$GREEN_PORT
            else
              echo "Current Front is GREEN ($GREEN_PORT). Deploying to BLUE ($BLUE_PORT)..."
              TARGET_COMPOSE_FILE="docker-compose-blue.yml"
              TARGET_FRONT_PORT=$BLUE_PORT
            fi

            # --- 3. ë¹„í™œì„±(Idle) í™˜ê²½ì— ìƒˆ 'front_server' ë°°í¬ ---
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE pull $SERVICE_NAME
            docker-compose -f docker-compose-infra.yml -f $TARGET_COMPOSE_FILE up -d --no-deps $SERVICE_NAME

            # --- 4. (ì¤‘ìš”) í—¬ìŠ¤ì²´í¬ (ê°„ë‹¨íˆ sleep) ---
            echo "Waiting for 30 seconds for service to start..."
            sleep 30 
            
            # --- 5. Nginx 'Front' íŠ¸ë˜í”½ ì „í™˜ ---
            echo "Switching Nginx traffic to $TARGET_FRONT_PORT..."
            echo "server 127.0.0.1:$TARGET_FRONT_PORT;" > $NGINX_CONF_PATH/conf.d/front_upstream.conf

            # --- 6. Nginx ì„¤ì • ë¦¬ë¡œë“œ (ì¤‘ë‹¨ ì—†ìŒ) ---
            sudo nginx -s reload
            
            echo "Deployment successful! Front traffic now routed to $TARGET_FRONT_PORT."
            docker image prune -f